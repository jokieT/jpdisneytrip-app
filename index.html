<script setup>
import { ref, computed } from 'vue'

// =======================
// 1. ÂÖ®Â±ÄËÆäÊï∏
// =======================
const activeTab = ref('itinerary')
const showSettings = ref(false)
const tripTitle = ref('TOKYO 2026')
const tripDate = ref('JAN 26 - JAN 31')
const activeMapUrl = ref(null)
const activeMapNote = ref('')

// =======================
// 2. Ë≥áÊñô Data
// =======================
const disneyLands = {
  land: [
    { name: 'ÁæéÂ•≥ËàáÈáéÁç∏', jp: 'ÁæéÂ•≥„Å®ÈáéÁç£' },
    { name: 'Ë≤ùÈ¶¨ÂÖãÊñØ', jp: '„Éô„Ç§„Éû„ÉÉ„ÇØ„Çπ' },
    { name: 'Â∑®Èõ∑Â±±', jp: '„Éì„ÉÉ„Ç∞„Çµ„É≥„ÉÄ„Éº' },
    { name: 'Â§™Á©∫Â±±', jp: '„Çπ„Éö„Éº„Çπ„Éª„Éû„Ç¶„É≥„ÉÜ„É≥' },
    { name: 'ÂπΩÈùàÂÖ¨È§®', jp: '„Éõ„Éº„É≥„ÉÜ„ÉÉ„Éâ„Éû„É≥„Ç∑„Éß„É≥' }
  ],
  sea: [
    { name: 'Â§¢ÂπªÂ•áËà™', jp: '„ÇΩ„Ç¢„É™„É≥' },
    { name: 'Áé©ÂÖ∑Á∏ΩÂãïÂì°', jp: '„Éà„Ç§„Éª„Çπ„Éà„Éº„É™„Éº' },
    { name: 'È©öÈ≠ÇÂè§Â°î', jp: '„Çø„ÉØ„Éº„Éª„Ç™„Éñ„Éª„ÉÜ„É©„Éº' },
    { name: 'Âç∞Á¨¨ÂÆâÁ¥çÁìäÊñØ', jp: '„Ç§„É≥„Éá„Ç£„Éª„Ç∏„Éß„Éº„É≥„Ç∫' }
  ]
}

const itinerary = ref([
  {
    id: 1, day: 'Day 1', date: '1/26',
    items: [
      { id: 101, time: '10:00', title: 'ÊàêÁî∞Ê©üÂ†¥ (NRT)', type: 'flight', note: 'CX500', mapUrl: 'https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3236.597!2d140.383!3d35.785!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x6022f37c3746653f%3A0x6b6d859d9551717!2sNarita%20International%20Airport!5e0!3m2!1sen!2shk' },
      { id: 102, time: '13:00', title: '‰∏äÈáéÈÖíÂ∫ó Check-in', type: 'hotel', note: 'APA Hotel', mapUrl: 'https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3239.656!2d139.771!3d35.710!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x60188e9ce34d31d7%3A0x7716940d990422!2sUeno%20Station!5e0!3m2!1sen!2shk' }
    ]
  }
])

const packingList = ref([
  { id: 'p1', name: 'Ë≠∑ÁÖß', category: 'docs', count: 1, checked: false },
  { id: 'p2', name: 'Êó•ÂúìÁèæÈáë', category: 'docs', count: 1, checked: false },
  { id: 'p3', name: 'Credit Cards', category: 'docs', count: 2, checked: false },
  { id: 'p4', name: 'SIM Âç°', category: 'docs', count: 1, checked: false },
  { id: 'p5', name: 'Ë°£Áâ©', category: 'clothes', count: 5, checked: false },
  { id: 'p6', name: 'ÂÖÖÈõªÁ∑ö', category: 'gadgets', count: 2, checked: false },
  { id: 'p7', name: 'ËΩâÊèíÈ†≠', category: 'gadgets', count: 2, checked: false },
  { id: 'p8', name: 'ÂÄã‰∫∫Ëó•Áâ©', category: 'personal', count: 1, checked: false }
])

const todos = ref([
  { id: 1, title: 'Ë≤∑‰øùÈö™', category: 'prep', status: 'done' },
  { id: 2, title: 'Ë®ÇËªäÈ£õ', category: 'prep', status: 'process' }
])

const expenses = ref([
  { id: 1, title: 'Skyliner', price: 2570, quantity: 2 },
  { id: 2, title: 'ÂÆµÂ§ú', price: 1200, quantity: 1 }
])

// Ëº∏ÂÖ•Ê°ÜÁãÄÊÖã
const newTime = ref('')
const newTitle = ref('')
const newNote = ref('')
const newMapUrl = ref('')
const selectedPark = ref('land')
const selectedFacility = ref('')
const newPackingItem = ref('')
const newTodo = ref('')
const newExpTitle = ref('')
const newExpPrice = ref('')

// Ë®àÁÆóÂ±¨ÊÄß
const totalExpense = computed(() => expenses.value.reduce((acc, cur) => acc + (cur.price * cur.quantity), 0))
const packingProgress = computed(() => packingList.value.length ? Math.round((packingList.value.filter(i => i.checked).length / packingList.value.length) * 100) : 0)
const todoProgress = computed(() => todos.value.length ? Math.round((todos.value.filter(t => t.status === 'done').length / todos.value.length) * 100) : 0)

const packingByCategory = computed(() => {
  const groups = { docs: { name: 'üõÇ Ë≠â‰ª∂', items: [] }, clothes: { name: 'üëï Ë°£Áâ©', items: [] }, gadgets: { name: 'üîå ÈõªÂ≠ê', items: [] }, personal: { name: 'üß¥ Áî®ÂìÅ', items: [] }, others: { name: 'üì¶ ÂÖ∂‰ªñ', items: [] } }
  packingList.value.forEach(item => { (groups[item.category] || groups.others).items.push(item) })
  return groups
})

// Êìç‰ΩúÂáΩÊï∏
const openMap = (url) => { if (url) activeMapUrl.value = url }
const closeMap = () => { activeMapUrl.value = null }

const addDisneyItem = () => {
  if (selectedFacility.value) {
    newTitle.value = selectedFacility.value.name + ' ' + selectedFacility.value.jp
    newNote.value = 'È†êË®àÊéíÈöä: -- min'
  }
}

const addItem = (dayIdx) => {
  if (newTitle.value) {
    itinerary.value[dayIdx].items.push({ id: Date.now(), time: newTime.value || '--:--', title: newTitle.value, type: 'activity', note: newNote.value, mapUrl: newMapUrl.value })
    newTitle.value = ''; newNote.value = ''; newMapUrl.value = '';
  }
}

const addPack = () => {
  if (newPackingItem.value) {
    packingList.value.push({ id: Date.now(), name: newPackingItem.value, category: 'others', count: 1, checked: false })
    newPackingItem.value = ''
  }
}
const updatePack = (item, n) => { if (item.count + n > 0) item.count += n }

const addTodo = () => {
  if (newTodo.value) {
    todos.value.push({ id: Date.now(), title: newTodo.value, category: 'prep', status: 'pending' })
    newTodo.value = ''
  }
}
const cycleStatus = (t) => { t.status = t.status === 'pending' ? 'process' : (t.status === 'process' ? 'done' : 'pending') }

const addExp = () => {
  if (newExpTitle.value && newExpPrice.value) {
    expenses.value.push({ id: Date.now(), title: newExpTitle.value, price: parseInt(newExpPrice.value), quantity: 1 })
    newExpTitle.value = ''; newExpPrice.value = '';
  }
}
const updateExp = (e, n) => { if (e.quantity + n > 0) e.quantity += n }

</script>

<template>
  <div class="min-h-screen bg-[#1a1b1e] text-gray-200 font-sans pb-28">
    
    <!-- Header -->
    <header class="sticky top-0 z-30 bg-[#1a1b1e]/90 backdrop-blur-md px-6 py-4 border-b border-gray-800 flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold text-white">{{ tripTitle }}</h1>
        <p class="text-xs text-blue-400 font-mono">{{ tripDate }}</p>
      </div>
      <button class="p-2 rounded-full bg-[#25262b]">‚öôÔ∏è</button>
    </header>

    <main class="p-4 max-w-lg mx-auto space-y-8">
      
      <!-- TAB: ITINERARY -->
      <div v-if="activeTab === 'itinerary'" class="space-y-8">
        <div class="p-5 rounded-2xl bg-[#1a1b1e] border border-gray-800">
          <h2 class="text-sm font-bold text-gray-400 mb-4">üìù Êñ∞Â¢ûË°åÁ®ã</h2>
          <div class="mb-4">
            <div class="flex gap-2 mb-2">
              <button @click="selectedPark='land'" :class="selectedPark==='land'?'bg-pink-600':'bg-gray-700'" class="flex-1 py-1 rounded text-xs">Land</button>
              <button @click="selectedPark='sea'" :class="selectedPark==='sea'?'bg-blue-600':'bg-gray-700'" class="flex-1 py-1 rounded text-xs">Sea</button>
            </div>
            <select v-model="selectedFacility" @change="addDisneyItem" class="w-full bg-[#25262b] text-sm p-2 rounded">
              <option value="">ÈÅ∏Êìá Disney Ë®≠ÊñΩ...</option>
              <option v-for="item in disneyLands[selectedPark]" :key="item.name" :value="item">{{ item.name }}</option>
            </select>
          </div>
          <div class="grid grid-cols-3 gap-3 mb-3">
            <input v-model="newTime" type="time" class="col-span-1 bg-[#25262b] rounded p-2 text-sm">
            <input v-model="newTitle" placeholder="Ê®ôÈ°å" class="col-span-2 bg-[#25262b] rounded p-2 text-sm">
          </div>
          <input v-model="newNote" placeholder="ÂÇôË®ª" class="w-full mb-3 bg-[#25262b] rounded p-2 text-sm">
          <input v-model="newMapUrl" placeholder="Google Maps URL" class="w-full mb-4 bg-[#25262b] rounded p-2 text-xs">
          <button @click="addItem(0)" class="w-full py-3 rounded bg-blue-600 font-bold">Âä†ÂÖ• Day 1</button>
        </div>

        <div v-for="(day, dIndex) in itinerary" :key="dIndex">
          <h2 class="text-xl font-bold text-white mb-4">{{ day.day }}</h2>
          <div class="space-y-4">
            <div v-for="item in day.items" :key="item.id" class="relative p-4 rounded-xl bg-[#25262b] border border-gray-800 flex gap-4">
              <div class="w-1.5 bg-blue-500 rounded-full"></div>
              <div class="flex-1">
                <span class="text-sm font-bold text-gray-400">{{ item.time }}</span>
                <h3 class="font-bold text-white text-lg">{{ item.title }}</h3>
                <p v-if="item.note" class="text-xs text-gray-400 mt-1">{{ item.note }}</p>
                <button v-if="item.mapUrl" @click="openMap(item.mapUrl)" class="mt-2 text-xs bg-gray-700 px-3 py-1 rounded text-blue-400">üìç Âú∞Âúñ</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: PACKING -->
      <div v-if="activeTab === 'packing'" class="space-y-6">
        <div class="p-6 rounded-2xl bg-[#25262b] border border-gray-800">
          <div class="flex justify-between items-end mb-2">
            <h2 class="text-2xl font-bold">Âü∑Ë°åÊùé</h2>
            <span class="text-3xl font-black text-yellow-400">{{ packingProgress }}%</span>
          </div>
          <div class="w-full h-2 bg-gray-700 rounded-full"><div class="h-full bg-yellow-400" :style="{width: packingProgress+'%'}"></div></div>
        </div>
        <div class="flex gap-2">
          <input v-model="newPackingItem" placeholder="Êñ∞Â¢ûÁâ©ÂìÅ..." class="flex-1 bg-[#25262b] p-2 rounded text-sm">
          <button @click="addPack" class="bg-yellow-500 text-black px-4 rounded font-bold">+</button>
        </div>
        <div v-for="(group, key) in packingByCategory" :key="key" v-show="group.items.length > 0">
          <h3 class="text-sm font-bold text-gray-500 mb-2 pl-1">{{ group.name }}</h3>
          <div v-for="item in group.items" :key="item.id" class="flex justify-between items-center p-3 mb-2 bg-[#25262b] rounded-xl border border-gray-800">
            <div @click="item.checked=!item.checked" class="flex items-center gap-3 flex-1 cursor-pointer">
              <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center" :class="item.checked?'bg-yellow-500 border-yellow-500':'border-gray-600'">
                <span v-if="item.checked" class="text-black text-xs">‚úì</span>
              </div>
              <span :class="{'line-through text-gray-500':item.checked}">{{ item.name }}</span>
            </div>
            <div class="flex items-center gap-2">
              <button @click="updatePack(item,-1)" class="px-2 text-gray-400">-</button>
              <span class="text-xs text-blue-300">{{ item.count }}</span>
              <button @click="updatePack(item,1)" class="px-2 text-gray-400">+</button>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: TODO -->
      <div v-if="activeTab === 'todo'" class="space-y-6">
        <div class="p-6 rounded-2xl bg-[#25262b] border border-gray-800">
          <div class="flex justify-between items-end mb-2">
            <h2 class="text-2xl font-bold">Ê∫ñÂÇôÊ∏ÖÂñÆ</h2>
            <span class="text-3xl font-black text-blue-500">{{ todoProgress }}%</span>
          </div>
          <div class="w-full h-2 bg-gray-700 rounded-full"><div class="h-full bg-blue-500" :style="{width: todoProgress+'%'}"></div></div>
        </div>
        <div class="flex gap-2">
          <input v-model="newTodo" placeholder="Êñ∞Â¢ûÂæÖËæ¶..." class="flex-1 bg-[#25262b] p-2 rounded text-sm">
          <button @click="addTodo" class="bg-blue-600 px-4 rounded font-bold">+</button>
        </div>
        <div v-for="todo in todos" :key="todo.id" class="p-4 mb-3 bg-[#25262b] rounded-xl border border-gray-800 flex gap-3">
          <button @click="cycleStatus(todo)" class="w-5 h-5 rounded-full border-2" :class="{'bg-green-500 border-green-500':todo.status==='done', 'bg-yellow-500/20 border-yellow-500':todo.status==='process', 'border-gray-500':todo.status==='pending'}"></button>
          <span :class="{'line-through text-gray-500':todo.status==='done'}">{{ todo.title }}</span>
        </div>
      </div>

      <!-- TAB: EXPENSE -->
      <div v-if="activeTab === 'expense'" class="space-y-6">
        <div class="p-6 rounded-2xl bg-gray-800 border border-gray-700 text-center">
          <p class="text-gray-400 text-sm">Á∏ΩÊ∂àË≤ª</p>
          <h2 class="text-4xl font-bold mt-2">¬•{{ totalExpense.toLocaleString() }}</h2>
        </div>
        <div class="grid grid-cols-4 gap-2">
          <input v-model="newExpTitle" placeholder="È†ÖÁõÆ" class="col-span-2 bg-[#25262b] p-2 rounded text-sm">
          <input v-model="newExpPrice" type="number" placeholder="¬•" class="col-span-1 bg-[#25262b] p-2 rounded text-sm">
          <button @click="addExp" class="bg-green-600 rounded font-bold">Add</button>
        </div>
        <div v-for="exp in expenses" :key="exp.id" class="p-4 mb-3 bg-[#25262b] rounded-xl border border-gray-800">
          <div class="flex justify-between mb-2">
            <span>{{ exp.title }} <span class="text-xs text-gray-500">@¬•{{ exp.price }}</span></span>
            <span class="font-mono text-green-400">¬•{{ (exp.price*exp.quantity).toLocaleString() }}</span>
          </div>
          <div class="flex justify-between items-center bg-[#1a1b1e] p-2 rounded">
            <span class="text-xs text-gray-400">Êï∏Èáè</span>
            <div class="flex gap-3">
              <button @click="updateExp(exp,-1)" class="px-2 text-gray-400">-</button>
              <span>{{ exp.quantity }}</span>
              <button @click="updateExp(exp,1)" class="px-2 text-gray-400">+</button>
            </div>
          </div>
        </div>
      </div>

    </main>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-6 left-6 right-6 h-16 bg-[#25262b]/95 backdrop-blur-md rounded-2xl flex justify-around items-center px-2 border border-gray-700 z-40">
      <button @click="activeTab='itinerary'" :class="activeTab==='itinerary'?'text-blue-400 scale-125':'text-gray-500'" class="text-2xl transition-all">üìÖ</button>
      <button @click="activeTab='packing'" :class="activeTab==='packing'?'text-yellow-400 scale-125':'text-gray-500'" class="text-2xl transition-all">üß≥</button>
      <button @click="activeTab='todo'" :class="activeTab==='todo'?'text-purple-400 scale-125':'text-gray-500'" class="text-2xl transition-all">‚úÖ</button>
      <button @click="activeTab='expense'" :class="activeTab==='expense'?'text-green-400 scale-125':'text-gray-500'" class="text-2xl transition-all">üí∞</button>
    </nav>

    <!-- Map Modal -->
    <div v-if="activeMapUrl" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4" @click.self="closeMap">
      <div class="w-full max-w-3xl bg-[#1a1b1e] rounded-2xl overflow-hidden h-[70vh] flex flex-col">
        <div class="flex justify-between p-4 bg-[#25262b]">
          <h3 class="font-bold">Âú∞Âúñ</h3>
          <button @click="closeMap">‚úï</button>
        </div>
        <iframe :src="activeMapUrl" class="flex-1 w-full border-0"></iframe>
      </div>
    </div>

  </div>
</template>

<style>
body { background-color: #1a1b1e; color: white; }
</style>

